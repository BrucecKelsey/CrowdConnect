<!DOCTYPE html>
<html>
<head>
    <title>Crowd Connect - DJ Dashboard</title>
    <link href="css/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu:700,900" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #ff00cc 0%, #333399 100%);
            min-height: 100vh;
            font-family: 'Ubuntu', sans-serif;
        }
        .dashboard-section {
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            box-shadow: 0 0 20px #ff00cc99;
            margin: 30px auto;
            padding: 30px 40px;
            max-width: 500px;
            text-align: center;
        }
        #partiesList li {
            background: linear-gradient(90deg, #fff700 0%, #ff00cc 100%);
            color: #333399;
            margin: 10px 0;
            padding: 12px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        #partiesList li.selected {
            background: linear-gradient(90deg, #ff00cc 0%, #fff700 100%);
            color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background: rgba(51, 51, 153, 0.8);
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: #fff;
            margin: 10vh auto;
            padding: 30px 40px;
            border-radius: 30px;
            width: 350px;
            box-shadow: 0 0 30px #ff00cc99;
            text-align: center;
            position: relative;
        }
        .close {
            position: absolute;
            top: 10px; right: 20px;
            font-size: 2em;
            color: #ff00cc;
            cursor: pointer;
            font-weight: bold;
        }
        #qrSection {
            margin: 20px 0;
        }
        #qrPlaceholder {
            margin: 10px auto;
            display: block;
        }
        #requestsList li {
            background: #fff700;
            color: #333399;
            margin: 8px 0;
            padding: 10px 15px;
            border-radius: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body style="background:#18181b; min-height:100vh; font-family:'Poppins', 'PT Sans', Arial, sans-serif;">
    <div class="container" style="max-width:1100px;margin:0 auto;padding:32px 8px;min-height:100vh;display:flex;flex-direction:column;">
        <header style="width:100%;max-width:800px;margin:0 auto 24px auto;">
            <div style="display:flex;justify-content:center;align-items:center;gap:16px;margin:24px 0 12px 0;flex-direction:column;">
                <div style="display:flex;align-items:center;gap:16px;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-12 w-12" style="color:#ff00cc;"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                    <h1 style="color:#fff;font-size:2.5rem;font-family:'Poppins','PT Sans',Arial,sans-serif;font-weight:700;letter-spacing:-1px;">Crowd Connect</h1>
                </div>
            </div>
        </header>
        <main style="width:100%;display:grid;grid-template-columns:1fr;gap:32px;max-width:800px;margin:0 auto;flex-grow:1;">
            <div style="grid-column:1/-1;">
                <div style="border-radius:16px;background:#23232b;color:#fff;box-shadow:0 4px 32px #0008;overflow:hidden;">
                    <div style="display:flex;flex-direction:row;align-items:center;justify-content:space-between;padding:24px 24px 0 24px;">
                        <div>
                            <div style="font-weight:600;font-size:1.5rem;font-family:'Poppins','PT Sans',Arial,sans-serif;">Your Events</div>
                            <div style="font-size:1rem;color:#bdbdbd;">Create and manage your events. Set one to 'Active' to receive song requests.</div>
                        </div>
                        <button onclick="showCreateParty();" style="display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,#ff00cc 0%,#fff700 100%);color:#18181b;font-weight:600;padding:10px 20px;border:none;border-radius:8px;font-size:1rem;box-shadow:0 2px 8px #ff00cc33;cursor:pointer;transition:background 0.2s;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>
                            Create Event
                        </button>
                    </div>
                    <div style="padding:32px 24px 24px 24px;">
                        <ul id="partiesList" style="list-style:none;padding:0;margin:0;"></ul>
                        <span id="partyResult" style="color:#ff0033;"></span>
                    </div>
                </div>
            </div>
            <aside style="grid-column:1/-1;">
                <div style="border-radius:16px;background:#23232b;color:#fff;box-shadow:0 2px 16px #0006;overflow:hidden;margin-top:32px;">
                    <div style="padding:24px 24px 0 24px;display:flex;flex-direction:column;gap:8px;">
                        <div style="font-size:1.5rem;font-weight:600;display:flex;align-items:center;gap:8px;font-family:'Poppins','PT Sans',Arial,sans-serif;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-qr-code"><rect width="5" height="5" x="3" y="3" rx="1"></rect><rect width="5" height="5" x="16" y="3" rx="1"></rect><rect width="5" height="5" x="3" y="16" rx="1"></rect><path d="M21 16h-3a2 2 0 0 0-2 2v3"></path><path d="M21 21v.01"></path><path d="M12 7v3a2 2 0 0 1-2 2H7"></path><path d="M3 12h.01"></path><path d="M12 3h.01"></path><path d="M12 16v.01"></path><path d="M16 12h1"></path><path d="M21 12v.01"></path><path d="M12 21v-1"></path></svg>
                            Share for Requests
                        </div>
                    </div>
                    <div style="padding:24px;display:flex;flex-direction:column;align-items:center;gap:16px;">
                        <p style="font-size:0.95rem;color:#bdbdbd;text-align:center;">Before sharing, make sure you have set an event to 'Active' to receive requests for the correct event.</p>
                        <div style="display:flex;width:100%;gap:12px;flex-wrap:wrap;">
                            <button onclick="showQRModal();" style="flex:1;display:inline-flex;align-items:center;gap:8px;background:#fff;color:#23232b;font-weight:600;padding:10px 0;border:none;border-radius:8px;font-size:1rem;box-shadow:0 2px 8px #ff00cc22;cursor:pointer;transition:background 0.2s;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4"><rect width="5" height="5" x="3" y="3" rx="1"></rect><rect width="5" height="5" x="16" y="3" rx="1"></rect><rect width="5" height="5" x="3" y="16" rx="1"></rect><path d="M21 16h-3a2 2 0 0 0-2 2v3"></path><path d="M21 21v.01"></path><path d="M12 7v3a2 2 0 0 1-2 2H7"></path><path d="M3 12h.01"></path><path d="M12 3h.01"></path><path d="M12 16v.01"></path><path d="M16 12h1"></path><path d="M21 12v.01"></path><path d="M12 21v-1"></path></svg>
                                Show QR Code
                            </button>
                            <button onclick="shareRequestLink();" style="flex:1;display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,#ff00cc 0%,#fff700 100%);color:#18181b;font-weight:600;padding:10px 0;border:none;border-radius:8px;font-size:1rem;box-shadow:0 2px 8px #ff00cc33;cursor:pointer;transition:background 0.2s;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"></line></svg>
                                Share Link
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
        </main>
        <footer style="width:100%;max-width:800px;margin:32px auto 0 auto;padding:32px 0 0 0;">
            <div style="display:flex;justify-content:center;">
                <a href="submit.html" style="text-decoration:none;">
                    <button style="display:inline-flex;align-items:center;gap:8px;background:none;color:#bdbdbd;font-size:1rem;font-weight:500;border:none;cursor:pointer;text-decoration:underline;">View request page
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2 h-4 w-4"><path d="M15 3h6v6"></path><path d="M10 14 21 3"></path><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path></svg>
                    </button>
                </a>
            </div>
        </footer>
    </div>
    <script>
        let djId = 1; // Replace with actual logged-in DJ ID
        let selectedPartyId = null;
        function showCreateParty() {
            document.getElementById('createPartyModal').style.display = 'block';
        }
        function closeCreateParty() {
            document.getElementById('createPartyModal').style.display = 'none';
        }
        function createParty() {
            let partyName = document.getElementById("partyName").value;
            let tmp = { partyName: partyName, djId: djId };
            let jsonPayload = JSON.stringify(tmp);
            let url = 'http://178.128.4.96/LAMPAPI/CreateParty.php';
            let xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-type", "application/json; charset=UTF-8");
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let jsonObject = JSON.parse(xhr.responseText);
                    if (!jsonObject.error) {
                        closeCreateParty();
                        loadParties();
                    } else {
                        document.getElementById("partyResult").innerHTML = jsonObject.error;
                    }
                }
            };
            xhr.send(jsonPayload);
        }
        function loadParties() {
            let url = 'http://178.128.4.96/LAMPAPI/GetParties.php?djId=' + djId;
            let xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let jsonObject = JSON.parse(xhr.responseText);
                    let partiesList = document.getElementById("partiesList");
                    partiesList.innerHTML = "";
                    if(jsonObject.parties.length === 0) {
                        partiesList.innerHTML = '<li>No parties found. Create one!</li>';
                    }
                    jsonObject.parties.forEach(function(party) {
                        let li = document.createElement("li");
                        li.textContent = party.PartyName;
                        li.setAttribute('data-partyid', party.PartyId);
                        li.onclick = function() { selectParty(party.PartyId, party.PartyName, li); };
                        partiesList.appendChild(li);
                    });
                }
            };
            xhr.send();
        }
        function selectParty(partyId, partyName, liElem) {
            // If already selected, deselect and close
            if (selectedPartyId === partyId) {
                selectedPartyId = null;
                document.getElementById("selectedPartySection").style.display = "none";
                document.getElementById("deletePartyBtn").style.display = "none";
                let lis = document.querySelectorAll('#partiesList li');
                lis.forEach(function(li){ li.classList.remove('selected'); });
                return;
            }
            selectedPartyId = partyId;
            document.getElementById("selectedPartySection").style.display = "block";
            document.getElementById("selectedPartyName").textContent = partyName;
            // Highlight selected
            let lis = document.querySelectorAll('#partiesList li');
            lis.forEach(function(li){ li.classList.remove('selected'); });
            liElem.classList.add('selected');
            // Generate QR
            let qr = new QRious({
                element: document.getElementById("qrPlaceholder"),
                value: window.location.origin + "/submit.html?partyId=" + partyId,
                size: 200
            });
            loadRequests(partyId);
            // Show delete button, center it
            var btn = document.getElementById("deletePartyBtn");
            btn.style.display = "block";
            btn.style.margin = "30px auto 0 auto";
        }

        document.getElementById("deletePartyBtn").onclick = function() {
            document.getElementById("deleteConfirmModal").style.display = 'block';
        };

        function closeDeleteConfirm() {
            document.getElementById("deleteConfirmModal").style.display = 'none';
        }

        function confirmDeleteParty() {
            if (!selectedPartyId) return;
            let url = 'http://178.128.4.96/LAMPAPI/DeleteParty.php';
            let tmp = { partyId: selectedPartyId };
            let jsonPayload = JSON.stringify(tmp);
            let xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-type", "application/json; charset=UTF-8");
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let jsonObject = JSON.parse(xhr.responseText);
                    closeDeleteConfirm();
                    if (!jsonObject.error) {
                        // Hide section, refresh parties
                        document.getElementById("selectedPartySection").style.display = "none";
                        document.getElementById("deletePartyBtn").style.display = "none";
                        selectedPartyId = null;
                        setTimeout(function() {
                            loadParties();
                        }, 200);
                    } else {
                        alert(jsonObject.error);
                    }
                }
            };
            xhr.send(jsonPayload);
        }
        function loadRequests(partyId) {
            let url = 'http://178.128.4.96/LAMPAPI/GetRequests.php?partyId=' + partyId;
            let xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let jsonObject = JSON.parse(xhr.responseText);
                    let requestsList = document.getElementById("requestsList");
                    requestsList.innerHTML = "";
                    if(jsonObject.requests.length === 0) {
                        requestsList.innerHTML = '<li>No requests yet.</li>';
                    }
                    jsonObject.requests.forEach(function(req) {
                        let li = document.createElement("li");
                        li.textContent = req.SongName + (req.RequestedBy ? " (by " + req.RequestedBy + ")" : "");
                        requestsList.appendChild(li);
                    });
                }
            };
            xhr.send();
        }
        // Add auto-refresh every 5 seconds
        function startAutoRefresh() {
            setInterval(function() {
                if(selectedPartyId) {
                    loadRequests(selectedPartyId);
                }
            }, 5000);
        }
        window.onload = function() {
            loadParties();
            startAutoRefresh();
            document.getElementById("deletePartyBtn").style.display = "none";
        };
    </script>
</body>
</html>
