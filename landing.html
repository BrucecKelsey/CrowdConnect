<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Crowd Connect</title>
    <link href="css/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 212.7 26.8% 83.9%;
            --radius: 0.5rem;
        }
        body {
            font-family: 'Poppins', 'PT Sans', 'Ubuntu', sans-serif;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            width: 100%;
            max-width: 56rem;
            margin: 0 auto 1rem auto;
        }
        .header-inner {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin: 0.5rem 0 1.5rem 0;
        }
        .header-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .logo-svg {
            height: 3rem;
            width: 3rem;
            color: hsl(var(--primary));
        }
        .headline {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Poppins', 'PT Sans', 'Ubuntu', sans-serif;
            letter-spacing: -0.02em;
        }
        main {
            width: 100%;
            max-width: 56rem;
            margin: 0 auto;
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        @media (min-width: 1024px) {
            main {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .card {
            border-radius: 0.5rem;
            border: 1px solid hsl(var(--border));
            background: hsl(var(--card));
            color: hsl(var(--card-foreground));
            box-shadow: 0 2px 8px 0 hsl(var(--primary) / 0.08);
        }
        .card.shadow-lg {
            box-shadow: 0 4px 24px 0 hsl(var(--primary) / 0.18);
        }
        .card-header {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 1rem 1rem 1rem;
        }
        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            font-family: 'Poppins', 'PT Sans', 'Ubuntu', sans-serif;
        }
        .card-desc {
            font-size: 1rem;
            color: hsl(var(--muted-foreground));
        }
        .card-content {
            padding: 1.5rem 1rem 1rem 1rem;
        }
        .empty-events {
            text-align: center;
            padding: 3rem 1.5rem;
            border: 2px dashed hsl(var(--border));
            border-radius: 0.5rem;
        }
        .empty-events svg {
            margin: 0 auto;
            display: block;
        }
        .empty-events h3 {
            margin-top: 1rem;
            font-size: 1.125rem;
            font-weight: 600;
            font-family: 'Poppins', 'PT Sans', 'Ubuntu', sans-serif;
        }
        .empty-events p {
            margin-top: 0.25rem;
            font-size: 0.95rem;
            color: hsl(var(--muted-foreground));
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-secondary {
            background: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
        }
        .btn:hover {
            background: hsl(var(--primary) / 0.9);
        }
        .btn-secondary:hover {
            background: hsl(var(--secondary) / 0.8);
        }
        .w-full { width: 100%; }
        .gap-2 { gap: 0.5rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .rounded-lg { border-radius: 0.5rem; }
        .shadow-lg { box-shadow: 0 4px 24px 0 hsl(var(--primary) / 0.18); }
        .shadow-sm { box-shadow: 0 2px 8px 0 hsl(var(--primary) / 0.08); }
        .mt-4 { margin-top: 1rem; }
        .ml-2 { margin-left: 0.5rem; }
        .underline-offset-4 { text-underline-offset: 4px; }
        .hover\:underline:hover { text-decoration: underline; }
        .text-muted-foreground { color: hsl(var(--muted-foreground)); }
        .text-primary { color: hsl(var(--primary)); }
        .text-primary-foreground { color: hsl(var(--primary-foreground)); }
    </style>
</head>
<body class="font-body antialiased min-h-screen bg-background">
    <div class="container">
        <header class="w-full max-w-4xl mx-auto mb-4">
            <div class="header-inner">
                <div class="header-row">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="logo-svg"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                    <h1 class="headline">Crowd Connect</h1>
                </div>
            </div>
        </header>
        <main class="w-full grid grid-cols-1 gap-8 max-w-4xl mx-auto flex-grow">
            <div>
                <div class="rounded-lg border bg-card text-card-foreground shadow-lg card" style="height: 400px;">
                    <div class="space-y-1.5 flex flex-row items-center justify-between p-4 card-header">
                        <div>
                            <div class="font-semibold tracking-tight font-headline text-2xl card-title">Your Events</div>
                            <div class="text-sm text-muted-foreground card-desc">Create and manage your events. Set one to 'Active' to receive song requests.</div>
                        </div>
                        <button class="btn" type="button" onclick="showCreateParty();">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-plus mr-2 h-4 w-4"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>
                            Create Event
                        </button>
                    </div>
                </div>
            </div>
            <div>
                <div class="rounded-lg border bg-card text-card-foreground shadow-lg card">
                    <div class="space-y-1.5 flex flex-row items-center justify-between p-4 card-header">
                        <div>
                            <div class="font-semibold tracking-tight font-headline text-2xl card-title">Share Requests</div>
                            <div class="text-sm text-muted-foreground card-desc">Share your event link to receive song requests from your audience.</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="w-full max-w-4xl mx-auto py-8">
            <div class="flex justify-center">
                <a href="/request">
                    <button class="btn underline-offset-4 hover:underline h-10 px-4 py-2 text-muted-foreground hover:text-primary">
                        View request page
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link ml-2 h-4 w-4"><path d="M15 3h6v6"></path><path d="M10 14 21 3"></path><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path></svg>
                    </button>
                </a>
            </div>
        </footer>
        <!-- Modals -->
        <div id="createPartyModal" class="dashboard-modal">
            <div class="dashboard-modal-content">
                <span class="close" onclick="closeCreateParty();">&times;</span>
                <h2 style="color:hsl(var(--primary));margin-bottom:18px;">Create a New Party</h2>
                <input type="text" id="partyName" class="login-input" placeholder="Party Name" />
                <button type="button" class="btn w-full mt-4" onclick="createParty();">Create Party</button>
            </div>
        </div>
        <div id="qrModal" class="dashboard-modal">
            <div class="dashboard-modal-content">
                <span class="close" onclick="closeQRModal();">&times;</span>
                <h2 style="color:hsl(var(--primary));margin-bottom:18px;">Shareable QR Code</h2>
                <canvas id="qrPlaceholder" style="margin: 0 auto; display: block;"></canvas>
                <p class="text-muted-foreground mt-4">Share this QR code with the crowd so they can submit song requests!</p>
            </div>
        </div>
    </div>
    <script>
        let djId = 1; // Replace with actual logged-in DJ ID
        let selectedPartyId = null;
        function showCreateParty() {
            document.getElementById('createPartyModal').style.display = 'block';
        }
        function closeCreateParty() {
            document.getElementById('createPartyModal').style.display = 'none';
        }
        function showQRModal() {
            document.getElementById('qrModal').style.display = 'block';
            // Generate QR for currently selected party or fallback
            let partyId = selectedPartyId || '';
            let qr = new QRious({
                element: document.getElementById("qrPlaceholder"),
                value: window.location.origin + "/submit.html?partyId=" + partyId,
                size: 200
            });
        }
        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }
        function createParty() {
            let partyName = document.getElementById("partyName").value;
            let tmp = { partyName: partyName, djId: djId };
            let jsonPayload = JSON.stringify(tmp);
            let url = 'http://178.128.4.96/LAMPAPI/CreateParty.php';
            let xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-type", "application/json; charset=UTF-8");
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let jsonObject = JSON.parse(xhr.responseText);
                    if (!jsonObject.error) {
                        closeCreateParty();
                        loadParties();
                    } else {
                        document.getElementById("partyResult").innerHTML = jsonObject.error;
                    }
                }
            };
            xhr.send(jsonPayload);
        }
        function loadParties() {
            let url = 'http://178.128.4.96/LAMPAPI/GetParties.php?djId=' + djId;
            let xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let jsonObject = JSON.parse(xhr.responseText);
                    let partiesList = document.getElementById("partiesList");
                    partiesList.innerHTML = "";
                    if(jsonObject.parties.length === 0) {
                        document.getElementById("emptyEvents").style.display = '';
                    } else {
                        document.getElementById("emptyEvents").style.display = 'none';
                        jsonObject.parties.forEach(function(party) {
                            let li = document.createElement("li");
                            li.textContent = party.PartyName;
                            li.setAttribute('data-partyid', party.PartyId);
                            li.onclick = function() { selectParty(party.PartyId, party.PartyName, li); };
                            partiesList.appendChild(li);
                        });
                    }
                }
            };
            xhr.send();
        }
        function selectParty(partyId, partyName, liElem) {
            selectedPartyId = partyId;
            // Highlight selected
            let lis = document.querySelectorAll('#partiesList li');
            lis.forEach(function(li){ li.classList.remove('selected'); });
            liElem.classList.add('selected');
        }
        function shareLink() {
            let partyId = selectedPartyId || '';
            let requestUrl = window.location.origin + "/submit.html?partyId=" + partyId;
            if (navigator.share) {
                navigator.share({
                    title: 'Request a Song!',
                    text: 'Scan the QR code or click the link to request a song.',
                    url: requestUrl,
                });
            } else {
                navigator.clipboard.writeText(requestUrl);
                alert('The request link has been copied to your clipboard.');
            }
        }
        window.onload = function() {
            loadParties();
        };
    </script>
    <script>
        // Check if the user is authenticated
        const userToken = localStorage.getItem('userToken');
        if (!userToken) {
            // Redirect to login page if no token is found
            window.location.href = './login.html';
        } else {
            console.log('User authenticated with token:', userToken);
        }
    </script>
</body>
</html>
